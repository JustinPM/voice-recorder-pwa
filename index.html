<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceNotes PWA</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: system-ui, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #f4f4f9; color: #333; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        .btn-record { background: #ff4757; color: white; }
        .btn-stop { background: #2f3542; color: white; }
        .search-bar { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .timeline-control { margin-bottom: 20px; font-size: 0.9em; display: flex; align-items: center; gap: 10px; }
        .word-cloud { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; background: #eef1f7; border-radius: 8px; margin-bottom: 20px; justify-content: center; }
        .cloud-word { cursor: pointer; color: #57606f; transition: transform 0.2s; }
        .cloud-word:hover { transform: scale(1.1); color: #ff4757; }
        .note-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .timestamp { font-size: 0.85em; color: #666; font-weight: bold; }
        audio { width: 100%; margin: 10px 0; height: 35px; }
        textarea { width: 100%; height: 60px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd; padding: 8px; box-sizing: border-box; font-family: inherit; }
    </style>
</head>
<body>

    <h2>üéôÔ∏è VoiceNotes</h2>
    
    <div class="card">
        <button id="recordBtn" class="btn-record">Start Recording</button>
        <button id="stopBtn" class="btn-stop" disabled>Stop</button>
        <div id="status" style="margin-top:10px; color: #ff4757; font-size: 0.9em;"></div>
    </div>

    <div class="card">
        <strong>Word Cloud</strong>
        <div id="wordCloud" class="word-cloud"></div>
    </div>

    <input type="text" id="searchBar" class="search-bar" placeholder="Search keywords...">
    
    <div class="timeline-control">
        <span>Timeline: Show last</span>
        <input type="number" id="timelineDays" value="30" style="width: 50px;"> 
        <span>days</span>
    </div>

    <div id="notesList"></div>

    <script>
        let db;
        let mediaRecorder;
        let audioChunks = [];

        // DB Setup
        const request = indexedDB.open("VoiceNotesDB", 2);
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if(!db.objectStoreNames.contains("notes")) {
                db.createObjectStore("notes", { keyPath: "id", autoIncrement: true });
            }
        };
        request.onsuccess = (e) => { db = e.target.result; displayNotes(); };

        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');

        recordBtn.onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            audioChunks = [];
            mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
            mediaRecorder.onstop = saveNote;
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            status.innerText = "‚óè Recording...";
        };

        stopBtn.onclick = () => {
            mediaRecorder.stop();
            recordBtn.disabled = false;
            stopBtn.disabled = true;
            status.innerText = "";
            // Automatic refresh is handled inside onstop (saveNote)
        };

        async function saveNote() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const now = new Date();
            const newNote = {
                audio: audioBlob,
                text: "",
                date: now.toLocaleDateString(),
                time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: now.getTime()
            };
            const tx = db.transaction("notes", "readwrite");
            tx.objectStore("notes").add(newNote);
            tx.oncomplete = () => displayNotes(); // Auto Refresh
        }

        async function displayNotes() {
            const list = document.getElementById('notesList');
            const cloud = document.getElementById('wordCloud');
            const filter = document.getElementById('searchBar').value.toLowerCase();
            const daysLimit = document.getElementById('timelineDays').value;
            const cutoff = Date.now() - (daysLimit * 24 * 60 * 60 * 1000);

            list.innerHTML = "";
            let allText = "";

            const tx = db.transaction("notes", "readonly");
            const store = tx.objectStore("notes");
            const cursorRequest = store.openCursor(null, 'prev');

            cursorRequest.onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const note = cursor.value;
                    const matchesSearch = note.text.toLowerCase().includes(filter);
                    const matchesTimeline = note.timestamp > cutoff;

                    if (matchesSearch && matchesTimeline) {
                        allText += " " + note.text;
                        const item = document.createElement('div
